name: ðŸš€ Build et GÃ©nÃ©ration des Documents (OptimisÃ©)

on:
  push:
    branches: [ main, develop, feature/* ]
    paths:
      - 'UF-Zoom/docs/**'
      - 'UF-Zoom/Slide-Oral.md'
      - 'Themes/**'
      - 'package.json'
      - 'UF-Zoom/generate-*.sh'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'UF-Zoom/docs/**'
      - 'UF-Zoom/Slide-Oral.md'
      - 'Themes/**'
      - 'package.json'
      - 'UF-Zoom/generate-*.sh'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Forcer la rÃ©gÃ©nÃ©ration des documents'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '20.x'
  CACHE_KEY: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

jobs:
  build-and-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸš€ Checkout du code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Pour l'historique complet des commits
      
    - name: ðŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'
        
    - name: ðŸ” VÃ©rification des prÃ©requis
      run: |
        echo "ðŸ” VÃ©rification des thÃ¨mes CSS..."
        ls -la Themes/ | grep -E '\.css$'
        echo ""
        echo "ðŸ” VÃ©rification des fichiers sources..."
        ls -la UF-Zoom/docs/ | grep -E '\.md$'
        ls -la UF-Zoom/ | grep -E 'Slide-Oral\.md$'
        echo ""
        echo "ðŸ” VÃ©rification des scripts..."
        ls -la UF-Zoom/ | grep -E 'generate-.*\.sh$'
        
    - name: ðŸ“¦ Installation des dÃ©pendances
      run: |
        echo "ðŸ“¦ Installation des dÃ©pendances npm..."
        npm ci --prefer-offline --no-audit
        
        echo "ðŸ“¦ Installation de Marp CLI..."
        npm install -g @marp-team/marp-cli
        
        echo "âœ… DÃ©pendances installÃ©es"
        
    - name: ðŸ—ï¸ Build du projet
      run: |
        echo "ðŸš€ Build du projet..."
        npm run build:frontend
        npm run build:backend
        echo "âœ… Build terminÃ©"
        
    - name: ðŸ“„ GÃ©nÃ©ration des documents
      run: |
        echo "ðŸ“„ GÃ©nÃ©ration des documents..."
        
        # CrÃ©er les dossiers de sortie
        mkdir -p UF-Zoom/docs/output UF-Zoom/output
        
        # GÃ©nÃ©rer le PDF
        echo "ðŸ“„ GÃ©nÃ©ration du PDF Dossier-Projet2.md..."
        bash UF-Zoom/generate-dossier-pdf.sh
        
        # GÃ©nÃ©rer les slides
        echo "ðŸ“„ GÃ©nÃ©ration des slides Slide-Oral.md..."
        bash UF-Zoom/generate-slide.sh
        
        echo "âœ… GÃ©nÃ©ration des documents terminÃ©e"
        
    - name: ðŸ” VÃ©rification des documents gÃ©nÃ©rÃ©s
      run: |
        echo "âœ… VÃ©rification des documents gÃ©nÃ©rÃ©s..."
        echo ""
        echo "--- PDF Dossier ---"
        ls -la UF-Zoom/docs/output/ | grep -E '\.pdf$'
        echo ""
        echo "--- Slides ---"
        ls -la UF-Zoom/output/ | grep -E 'Slide-Oral\.(html|pdf|pptx)$'
        
        # VÃ©rifier les tailles
        echo ""
        echo "ðŸ“Š Tailles des fichiers :"
        if [ -f "UF-Zoom/docs/output/Dossier-Projet2.pdf" ]; then
            echo "  - Dossier-Projet2.pdf: $(du -h UF-Zoom/docs/output/Dossier-Projet2.pdf | cut -f1)"
        fi
        if [ -f "UF-Zoom/output/Slide-Oral.pdf" ]; then
            echo "  - Slide-Oral.pdf: $(du -h UF-Zoom/output/Slide-Oral.pdf | cut -f1)"
        fi
        
    - name: ðŸ“¤ Upload des documents gÃ©nÃ©rÃ©s
      uses: actions/upload-artifact@v4
      with:
        name: documents-generes-${{ github.sha }}
        path: |
          UF-Zoom/docs/output/
          UF-Zoom/output/
        retention-days: 90
        if-no-files-found: error
        
    - name: ðŸ’¬ Commentaire automatique sur les PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          let comment = '## ðŸ“„ Documents gÃ©nÃ©rÃ©s automatiquement\n\n';
          comment += 'âœ… **Build rÃ©ussi** avec gÃ©nÃ©ration automatique des documents\n\n';
          
          comment += '### ðŸ“ Fichiers disponibles\n';
          
          // VÃ©rifier le PDF du dossier
          const dossierPdf = 'UF-Zoom/docs/output/Dossier-Projet2.pdf';
          if (fs.existsSync(dossierPdf)) {
            const stats = fs.statSync(dossierPdf);
            const sizeInMB = (stats.size / (1024 * 1024)).toFixed(1);
            comment += `- **ðŸ“„ Dossier-Projet2.pdf** : \`${dossierPdf}\` (${sizeInMB} MB)\n`;
          }
          
          // VÃ©rifier les slides
          const slidesDir = 'UF-Zoom/output';
          if (fs.existsSync(slidesDir)) {
            const files = fs.readdirSync(slidesDir);
            files.forEach(file => {
              if (file.match(/Slide-Oral\.(html|pdf|pptx)$/)) {
                const filePath = path.join(slidesDir, file);
                const stats = fs.statSync(filePath);
                const sizeInMB = (stats.size / (1024 * 1024)).toFixed(1);
                const extension = path.extname(file).toUpperCase();
                comment += `- **ðŸ“Š Slide ${extension}** : \`${filePath}\` (${sizeInMB} MB)\n`;
              }
            });
          }
          
          comment += '\n### ðŸ”„ Workflow\n';
          comment += '1. ðŸ—ï¸ Build du projet (frontend + backend)\n';
          comment += '2. ðŸ“„ GÃ©nÃ©ration automatique des documents\n';
          comment += '3. ðŸ“¤ Upload des artifacts\n';
          comment += '4. ðŸ’¬ Commentaire automatique\n\n';
          
          comment += 'ðŸ’¡ **Ces documents sont gÃ©nÃ©rÃ©s automatiquement Ã  chaque modification de la documentation.**\n\n';
          comment += 'ðŸ”— **Artifacts disponibles dans l\'onglet Actions de cette PR**';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
    - name: ðŸ·ï¸ Tag des versions
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
      run: |
        echo "ðŸ·ï¸ CrÃ©ation des tags de version..."
        
        # Obtenir la version depuis package.json
        VERSION=$(node -p "require('./package.json').version")
        COMMIT_SHA=$(git rev-parse --short HEAD)
        DATE=$(date +%Y%m%d)
        
        # CrÃ©er un tag unique
        TAG="v${VERSION}-docs-${DATE}-${COMMIT_SHA}"
        
        echo "ðŸ“ CrÃ©ation du tag: $TAG"
        git tag "$TAG"
        git push origin "$TAG"
        
        echo "âœ… Tag crÃ©Ã© et poussÃ©: $TAG"
        
    - name: ðŸ“Š Rapport de build
      run: |
        echo "ðŸ“Š GÃ©nÃ©ration du rapport de build..."
        
        REPORT_FILE="build-docs-report.txt"
        
        cat > "$REPORT_FILE" << EOF
# ðŸ“Š Rapport de Build - GÃ©nÃ©ration des Documents
Date: $(date)
Commit: ${{ github.sha }}
Branch: ${{ github.ref_name | replace("/", "-") }}
Workflow: ${{ github.workflow }}

## ðŸ—ï¸ Informations du build
- **Runner**: ${{ runner.os }} (${{ runner.arch }})
- **Node.js**: ${{ env.NODE_VERSION }}
- **Cache**: ${{ env.CACHE_KEY }}

## ðŸ“„ Documents gÃ©nÃ©rÃ©s

### PDF - Dossier-Projet2.md
- Fichier: UF-Zoom/docs/output/Dossier-Projet2.pdf
- Taille: $(du -h "UF-Zoom/docs/output/Dossier-Projet2.pdf" | cut -f1)
- ThÃ¨me: resume2-A4.css
- Format: A4 Portrait

### Slides - Slide-Oral.md
- PDF: UF-Zoom/output/Slide-Oral.pdf
- HTML: UF-Zoom/output/Slide-Oral.html
- PPTX: UF-Zoom/output/Slide-Oral.pptx
- ThÃ¨me: yas-eco.css

## ðŸ” VÃ©rifications
- âœ… ThÃ¨mes CSS disponibles
- âœ… Fichiers sources trouvÃ©s
- âœ… Build du projet rÃ©ussi
- âœ… Documents gÃ©nÃ©rÃ©s
- âœ… Artifacts uploadÃ©s

## ðŸ“ˆ MÃ©triques
- Temps de build: ${{ steps.build-and-docs.outputs.build-time }}
- Taille totale des documents: $(du -sh "UF-Zoom/docs/output/" "UF-Zoom/output/" | awk '{sum+=$1} END {print sum "B"}')

## ðŸŽ¯ Statut
âœ… Build terminÃ© avec succÃ¨s
EOF
        
        echo "âœ… Rapport de build gÃ©nÃ©rÃ©: $REPORT_FILE"
        
    - name: ðŸ“¤ Upload du rapport
      uses: actions/upload-artifact@v4
      with:
        name: rapport-build-${{ github.sha }}
        path: build-docs-report.txt
        retention-days: 90
        
    - name: ðŸŽ‰ Notification de succÃ¨s
      if: success()
      run: |
        echo "ðŸŽ‰ Build et gÃ©nÃ©ration des documents terminÃ©s avec succÃ¨s !"
        echo "ðŸ“„ Documents disponibles dans les artifacts GitHub Actions"
        echo "ðŸ“Š Rapport de build gÃ©nÃ©rÃ©"
        
    - name: âŒ Notification d'Ã©chec
      if: failure()
      run: |
        echo "âŒ Ã‰chec du build ou de la gÃ©nÃ©ration des documents"
        echo "ðŸ“‹ VÃ©rifiez les logs pour plus de dÃ©tails"
        echo "ðŸ”§ VÃ©rifiez les prÃ©requis et la configuration" 